///////////////////////////////////////////////////////////////////////////////
// NIXIE Clock                                                               //
// Adam Greig, April 2009                                                    //
// Main Code                                                                 //
///////////////////////////////////////////////////////////////////////////////

//============================================================================
// Includes
//----------------------------------------------

#include <stdlib.h>
#include <avr/io.h>
#include <util/delay.h>

#include "input.h"
#include "rtc.h"
#include "shift.h"

//============================================================================
// Constants
//----------------------------------------------

// Power Supply shutdown
#define SHDN PC0

//============================================================================
// Globals
//----------------------------------------------

// Store the date and time in BCD
unsigned short int sec_t, sec_u, min_t, min_u, hour_t, hour_u, day;
unsigned short int date_t, date_u, month_t, month_u, year_t, year_u;

//============================================================================
//============================================================================
// Initialisation
//----------------------------------------------

void setup() {

    // Zero all the ports to start with
    DDRB  = DDRC  = DDRD  = 0;
    PORTB = PORTC = PORTD = 0;
    
    // Set SHDN to an output and set it low
    DDRC |= (1<<SHDN);
    PORTC &= ~(1<<SHDN);

    i2c_init();
    input_init();
    shift_init();
    
}

//============================================================================
// Main Loop
//----------------------------------------------

void loop() {
    input_scan();
    rtc_read();
    shift_out_time();
    _delay_ms(400);
}

//============================================================================
//============================================================================
// Code entry point
//----------------------------------------------

int main(void) {
    setup();
    for(;;)
        loop();
    return 0;
}
